
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Motion Correction tips &#8212; CaImAn 1.4 documentation</title>
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">CaImAn 1.4 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="motion-correction-tips">
<h1>Motion Correction tips<a class="headerlink" href="#motion-correction-tips" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Non-rigid motion correction is not always necessary. Sometimes, rigid
motion correction will be sufficient and it will lead to significant
performance gains in terms of speed. Check your data to before/after
rigid motion correction to decide what is best for you. The boolean
parameter <code class="docutils literal notranslate"><span class="pre">params.motion.pw_rigid</span></code> can be used to alternate between
rigid and non-rigid motion correction using the same function
<code class="docutils literal notranslate"><span class="pre">MotionCorrect.motion_correct</span></code>.</p></li>
<li><p>When using piecewise rigid motion correction, use parameters that
physically make sense. For example, a typical patch size could be
around 100um x 100um since motion can in many times be approximated
as rigid for smaller patches (if the imaging is not too slow).
Similarly, the maximum allowed shifts can in typical 2p recordings
chosen to correspond to 10um. The patch size is given by the sum of
the parameters <code class="docutils literal notranslate"><span class="pre">params.motion.strides</span> <span class="pre">+</span> <span class="pre">params.motion.overlaps</span></code>.
The maximum shifts parameter is <code class="docutils literal notranslate"><span class="pre">params.motion.max_shifts</span></code>. These
values corresponds to pixels so make sure you have a rough idea of
the spatial resolution of your data. There is a parameter for that
<code class="docutils literal notranslate"><span class="pre">params.data.dxy</span></code>.</p></li>
<li><p>Motion correction works in parallel by splitting each file in
multiple chunks and processing them in parallel. Make sure that the
length of each chunk is not too small by setting the parameter
<code class="docutils literal notranslate"><span class="pre">params.motion.num_frames_split</span></code>.</p></li>
</ul>
</div>
<div class="section" id="caiman-online-processing-tips">
<h1>CaImAn Online Processing tips<a class="headerlink" href="#caiman-online-processing-tips" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Important parameters for online processing are the CNN threshold
value <code class="docutils literal notranslate"><span class="pre">params.online.thresh_CNN_noisy</span></code>, the trace SNR
<code class="docutils literal notranslate"><span class="pre">params.online.min_SNR</span></code> and the number of candidate components to
be considered at each timestep <code class="docutils literal notranslate"><span class="pre">params.online.min_num_trial</span></code>. Lower
values for the thresholds (e.g., 1 for <code class="docutils literal notranslate"><span class="pre">params.online.min_SNR</span></code> and
0.5 for <code class="docutils literal notranslate"><span class="pre">params.online.thresh_CNN_noisy</span></code>) and/or higher values for
<code class="docutils literal notranslate"><span class="pre">params.online.min_num_trial</span></code> (e.g., 10) can lead to higher recall
values, although potentially at the expense of lower precision. In
general they are preferable for datasets that are relatively short
(e.g., 10000 frames or less). On the other hand, higher threshold
values (e.g., 1.5 for <code class="docutils literal notranslate"><span class="pre">params.online.min_SNR</span></code> and 0.7 for
<code class="docutils literal notranslate"><span class="pre">params.online.thresh_CNN_noisy</span></code>) and/or lower values for
<code class="docutils literal notranslate"><span class="pre">params.online.min_num_trial</span></code> (e.g., 5) will lead to higher
precision values, although potentially at the expense of lower
recall. n general they are preferable for datasets that are longer
(e.g., 10000 frames or more).</p></li>
<li><p>If your analysis setup allows it, multiple epochs over the data can
be very beneficial, especially in the strict regime or high
acceptance thresholds.</p></li>
<li><p>In general, <code class="docutils literal notranslate"><span class="pre">bare</span></code> initialization can be used most of the times, to
capture the neuropil activity and a small number of neurons at an
initial chunk. For a large FOV with lots of active neurons, e.g., a
plane from a zebrafish dataset, <code class="docutils literal notranslate"><span class="pre">bare</span></code> initialization can be
inadequate. In this case, a proper initialization with <code class="docutils literal notranslate"><span class="pre">cnmf</span></code> can
lead to substantially better results.</p></li>
<li><p>Spatial downsampling can lead to significant speed gains, often at no
expense in terms of accuracy. It can be set through the parameter
<code class="docutils literal notranslate"><span class="pre">ds_factor</span></code>.</p></li>
<li><p>When using the CNN for screening candidate components, the usage of a
GPU can lead to significant computational gains.</p></li>
</ul>
</div>
<div class="section" id="caiman-batch-processing-tips">
<h1>CaImAn Batch processing tips<a class="headerlink" href="#caiman-batch-processing-tips" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>In order to optimize memory consumption and parallelize computing, it
is suggested to adopt computing in patches (see companion paper). The
user will inspect the correlation image and select an appropriate
number of neurons per each patch. The
<code class="docutils literal notranslate"><span class="pre">params.patches['rf']'</span> <span class="pre">and</span></code>params.patches.stride’ parameters
controls the size of patches and their overlap. Given the patch size
and the correlation image the user can set an upper bound on the
number of neurons per patches. We suggest to start exploring regions
that contain 4-10 neurons.</p></li>
<li><p>Important parameters for selecting components based on quality are</p></li>
<li><p>the CNN lower bound and upper threshold <code class="docutils literal notranslate"><span class="pre">params.quality.cnn_lowest</span></code>
and <code class="docutils literal notranslate"><span class="pre">params.quality.min_cnn_thr</span></code></p></li>
<li><p>the trace SNR <code class="docutils literal notranslate"><span class="pre">params.quality.min_SNR</span></code></p></li>
<li><p>the footprint consistency threshold <code class="docutils literal notranslate"><span class="pre">params.quality.rval_thr</span></code></p></li>
</ul>
<p>The user should explore these parameters around the default to optimize
for specific data sets.</p>
</div>
<div class="section" id="p-processing-tips">
<h1>1p processing tips<a class="headerlink" href="#p-processing-tips" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>For microendoscopic 1p data use CNMF-E’s background model and
initialization method by setting <code class="docutils literal notranslate"><span class="pre">center_psf=True</span></code>,
<code class="docutils literal notranslate"><span class="pre">method_init='corr_pnr'</span></code> and <code class="docutils literal notranslate"><span class="pre">ring_size_factor</span></code> to some value
around 1.5. In this case the spatial and temporal components are
updated during the initialization phase, hence use
<code class="docutils literal notranslate"><span class="pre">only_init_patch=True</span></code>.</p></li>
<li><p>Other important parameters for microendoscopic 1p data are <code class="docutils literal notranslate"><span class="pre">gSig</span></code>,
<code class="docutils literal notranslate"><span class="pre">gSiz</span></code>, <code class="docutils literal notranslate"><span class="pre">min_corr</span></code> and <code class="docutils literal notranslate"><span class="pre">min_pnr</span></code>. <code class="docutils literal notranslate"><span class="pre">gSig</span></code> specifies the
gaussian width of a 2D gaussian kernel, which approximates a neuron
and <code class="docutils literal notranslate"><span class="pre">gSiz</span></code> the average diameter of a neuron, in general
<code class="docutils literal notranslate"><span class="pre">4*gSig+1</span></code>. To pick the thresholds <code class="docutils literal notranslate"><span class="pre">min_corr</span></code> and <code class="docutils literal notranslate"><span class="pre">min_pnr</span></code> you
can use <code class="docutils literal notranslate"><span class="pre">caiman.utils.visualization.inspect_correlation_pnr</span></code> and
vary the slider values.</p></li>
<li><p>Because the background has no high spatial frequency components, it
can be spatially downscaled to speed up processing without loss in
accuracy, e.g. by a factor of 2 by setting <code class="docutils literal notranslate"><span class="pre">ssub_B=2</span></code>.</p></li>
<li><p>The exact background can be returned as full rank matrix
(<code class="docutils literal notranslate"><span class="pre">gnb=-1</span></code>), or more compactly as parameters of the ring model
(<code class="docutils literal notranslate"><span class="pre">gnb=0</span></code>), or not at all (<code class="docutils literal notranslate"><span class="pre">gnb&lt;-1</span></code>). Further the background can
also be approximated as low rank matrix by setting <code class="docutils literal notranslate"><span class="pre">gnb</span></code> to the
desired rank. <code class="docutils literal notranslate"><span class="pre">gnb=0</span></code> is usually the desired choice. If you have
plenty of RAM and process in patches <code class="docutils literal notranslate"><span class="pre">gnb=-1</span></code> is a good and faster
option.</p></li>
<li><p>The CNMF-E algorithm poses high demands on RAM. There is however a
trade off between computing time and memory usage when processing in
patches. The number of processes <code class="docutils literal notranslate"><span class="pre">n_processes</span></code> specifies how many
patches are processed in parallel, thus a higher number decreases
computing time but increases RAM usage. If you have insufficient RAM,
use a smaller value for <code class="docutils literal notranslate"><span class="pre">n_processes</span></code> to reduce memory consumption,
or don’t even use parallelization at all by setting <code class="docutils literal notranslate"><span class="pre">dview=None</span></code>.</p></li>
</ul>
</div>
<div class="section" id="deconvolution-tips">
<h1>Deconvolution tips<a class="headerlink" href="#deconvolution-tips" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Simultaneous deconvolution and source extraction can mostly offer
benefits in particularly low SNR data. In most cases, running source
extraction without deconvolution (<code class="docutils literal notranslate"><span class="pre">p=0</span></code>), followed by deconvolution
will be sufficient.</p></li>
<li><p>It is generally better to perform some sort of de-trending on the
extracted calcium traces prior to deconvolution to correct for
baseline drifts that can results in wrongfully deconvolved neural
activity. You can use the <code class="docutils literal notranslate"><span class="pre">estimates.detrend_df_f</span></code> methods for
that.</p></li>
<li><p>For interpreting the deconvolved neural activity varible <code class="docutils literal notranslate"><span class="pre">S</span></code>, see
<a class="reference external" href="https://github.com/flatironinstitute/CaImAn-MATLAB/wiki/Interpretation-of-spiking-variable-S">here</a>.</p></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Motion Correction tips</a></li>
<li><a class="reference internal" href="#caiman-online-processing-tips">CaImAn Online Processing tips</a></li>
<li><a class="reference internal" href="#caiman-batch-processing-tips">CaImAn Batch processing tips</a></li>
<li><a class="reference internal" href="#p-processing-tips">1p processing tips</a></li>
<li><a class="reference internal" href="#deconvolution-tips">Deconvolution tips</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/CaImAn-Tips.md.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">CaImAn 1.4 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Flatiron Institute, Simons Foundation, New York, NY.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.0.
    </div>
  </body>
</html>